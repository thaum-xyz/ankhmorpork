---
kube_vip_image: ghcr.io/kube-vip/kube-vip:v0.6.0
kube_vip_ip: "192.168.2.29"  # VIP IP managed by kube-vip

k3s_version: v1.27.2+k3s1
k3s_master_ip: "{{ hostvars[groups['k3s_control_plane'][0]]['ansible_default_ipv4']['address'] }}"
#k3s_master_ip: "{{ kube_vip_ip }}"

k3s_token: "{{ hostvars[groups['k3s_control_plane'][0]]['token'] }}"

k3s_server_config:
  disable:
  - servicelb
  - traefik
  - local-storage
  disable-cloud-controller: "true"
  kubelet-arg:
  - "system-reserved=cpu=100m,memory=230Mi"
  - "kube-reserved=cpu=200m,memory=100Mi"
  #- "feature-gates=PodAndContainerStatsFromCRI=true,ComponentSLIs=true" # Remove ComponentSLIs when k3s 1.27 is released
  - "feature-gates=ComponentSLIs=true" # Remove ComponentSLIs when k3s 1.27 is released
  kube-controller-manager-arg:
  - "bind-address=0.0.0.0"
  kube-scheduler-arg:
  - "bind-address=0.0.0.0"
  etcd-expose-metrics: "true"
  kube-proxy-arg:
  - "metrics-bind-address=0.0.0.0"
  kube-apiserver-arg:
  - "feature-gates=PDBUnhealthyPodEvictionPolicy=true"
  - "enable-admission-plugins=NamespaceAutoProvision"
  resolv-conf: "/run/systemd/resolve/resolv.conf"

k3s_agent_config:
  kubelet-arg:
  - "system-reserved=cpu=250m,memory=300Mi"
  - "kube-reserved=cpu=200m,memory=150Mi"
  - "allowed-unsafe-sysctls=net.ipv4.tcp_adv_win_scale"
  - "feature-gates=ComponentSLIs=true" # Remove ComponentSLIs when k3s 1.27 is released
  node-label:
  - "network.infra/type={{ network | default('fast') }}"
  - "storage.infra/local={{ 'false' if k3s_no_local_storage is defined else 'true' }}"
  kube-proxy-arg:
  - "metrics-bind-address=0.0.0.0"
  resolv-conf: "/run/systemd/resolve/resolv.conf"

system_mountpoints:
  - description: k3s data
    before: "k3s.service"
    device: "/dev/ubuntu-vg/rancher"
    mountpoint: "/var/lib/rancher"
    type: "ext4"
  - description: longhorn storage
    after: "var-lib-rancher.mount"
    before: "k3s.service"
    device: "/dev/secondary-vg/longhorn"
    mountpoint: "/var/lib/rancher/longhorn"
    type: "xfs"

