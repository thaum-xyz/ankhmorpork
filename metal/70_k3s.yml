---
- hosts: k3s
  become: true
  any_errors_fatal: true
  roles:
    - k3s-prereq
    - k3s-download
  tasks:
    - name: Use legacy iptables on debian systems
      alternatives:
        name: iptables
        path: /usr/sbin/iptables-legacy
      when: ansible_os_family == 'Debian'

- hosts: k3s_control_plane
  become: true
  any_errors_fatal: true
  roles:
    - k3s-master
  tasks:
    - name: Get kube config to deployer host
      fetch:
        src: "/etc/rancher/k3s/k3s.yaml"
        dest: "{{ playbook_dir }}/kubeconfig"
        flat: true

    - name: Replace localhost with master IP
      become: false
      replace:
        path: "{{ playbook_dir }}/kubeconfig"
        regexp: "127.0.0.1"
        replace: "{{ k3s_master_ip }}"
      delegate_to: localhost

    - name: Import manifests bound to infrastructure
      template:
        src: "{{ item }}"
        dest: "/var/lib/rancher/k3s/server/manifests/{{ item | basename }}"
      with_fileglob: "templates/manifests/*.yaml"

- hosts: k3s_nodes
  become: true
  serial: 2
  roles:
    - k3s-node
