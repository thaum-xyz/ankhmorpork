# Config reference: https://github.com/deliveryhero/helm-charts/blob/master/stable/node-problem-detector/values.yaml

image:
  tag: v0.8.20

metrics:
  enabled: true
  serviceMonitor:
    enabled: true

  prometheusRule:
    enabled: true

resources:
  limits:
    cpu: 20m
    memory: 60Mi
  requests:
    cpu: 3m
    memory: 18Mi

settings:
  #log_monitors:
  #  - /config/kernel-monitor.json
  #  - /config/readonly-monitor.json
  #  - /config/health-checker-containerd.json
  log_monitors:
    - /config/kernel-monitor.json
    - /config/readonly-monitor.json
    - /custom-config/health-checker-containerd.json

  custom_monitor_definitions:
    health-checker-containerd.json: |
      {
        "plugin": "custom",
        "pluginConfig": {
          "invoke_interval": "10s",
          "timeout": "3m",
          "max_output_length": "80",
          "concurrency": "1"
        },
        "source": "health-checker",
        "metricsReporting": true,
        "conditions": [
          {
            "type": "ContainerRuntimeUnhealthy",
            "reason": "ContainerRuntimeIsHealthy",
            "message": "Container runtime on the node is functioning properly"
          }
        ],
        "rules": [
          {
            "type": "permanent",
            "condition": "ContainerRuntimeUnhealthy",
            "reason": "ContainerdUnhealthy",
            "path": "/home/kubernetes/bin/health-checker",
            "args": [
              "--component=cri",
              "--enable-repair=true",
              "--cooldown-time=2m",
              "--health-check-timeout=60s"
            ],
            "timeout": "3m"
          }
        ]
      }
