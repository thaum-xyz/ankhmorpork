name: Upgrade to latest versions

on:
  schedule:
    - cron: '15 */6 * * *'
  #push:
  #  branch: main

env:
  golang-version: 1.18.4
  jsonnet-version: 0.18.0
  jb-version: 3aec759b6a423f5b50751443ccc81e91a0887c02  # Commit from mid February 2022

jobs:
  versions:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-go@v3
      with:
        go-version: '${{ env.golang-version }}'
    - name: Get jsonnet
      run: go install github.com/google/go-jsonnet/cmd/jsonnet@${{ env.jsonnet-version }}
    - name: Get jsonnet-bundler
      run: go install github.com/jsonnet-bundler/jsonnet-bundler/cmd/jb@${{ env.jb-version }}
    - name: Get yamlfmt
      run: go install github.com/devopyio/yamlfmt@latest
    - name: Upgrade
      run: |
        export GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}
        make upgrade
    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v4
      with:
        commit-message: "[bot] Automated version update"
        title: "[bot] Automated version update"
        body: |
          This is an automated version update performed from CI on behalf of @paulfantom.

          Configuration of the workflow is located in `.github/workflows/versions.yaml`
        assignees: paulfantom
        labels: enhancement
        branch: automated-updates
        delete-branch: true
        token: ${{ secrets.PAT_SECRET }}
